name: okernet - Sync upstream (modoboa/modoboa)

on:
  schedule:
    # Every 6 hours
    - cron: "17 */6 * * *"
  workflow_dispatch:
  repository_dispatch:
    types: [upstream-sync]

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_PAT }}

      - name: Sync upstream and tag new releases
        id: sync
        env:
          UPSTREAM_URL: https://github.com/modoboa/modoboa.git
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          DEFAULT_BRANCH="$(git remote show origin | awk '/HEAD branch/ {print $NF}')"
          echo "Default branch: ${DEFAULT_BRANCH}"

          if ! git remote | grep -q '^upstream$'; then
            git remote add upstream "${UPSTREAM_URL}"
          fi

          git fetch upstream --prune --tags

          git checkout "${DEFAULT_BRANCH}"

          # Merge upstream default branch into ours
          git merge --no-edit "upstream/${DEFAULT_BRANCH}" || {
            echo "Merge failed (likely conflicts). Resolve manually in a PR or locally."
            exit 1
          }

          git push origin "${DEFAULT_BRANCH}"

          # Find the latest upstream semver tag (fetched locally)
          LATEST_UPSTREAM="$(git tag -l --sort=-v:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | head -1)"
          echo "Latest upstream tag: ${LATEST_UPSTREAM:-none}"

          # Check if this tag already exists on origin
          if [ -n "$LATEST_UPSTREAM" ]; then
            EXISTING="$(git ls-remote --tags origin "refs/tags/${LATEST_UPSTREAM}" 2>/dev/null || true)"
            if [ -z "$EXISTING" ]; then
              echo "New upstream release: ${LATEST_UPSTREAM}"

              # Delete the upstream tag locally (it points to an upstream commit
              # that does NOT contain our okernet/ custom files)
              git tag -d "${LATEST_UPSTREAM}"

              # Re-create the tag on OUR master HEAD (includes Dockerfiles etc.)
              git tag -a "${LATEST_UPSTREAM}" -m "Release ${LATEST_UPSTREAM} (from upstream modoboa/modoboa)"
              git push origin "${LATEST_UPSTREAM}"

              echo "new_tag=${LATEST_UPSTREAM}" >> "$GITHUB_OUTPUT"
            else
              echo "Tag ${LATEST_UPSTREAM} already exists on origin; skipping."
              echo "new_tag=" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "No semver tags found."
            echo "new_tag=" >> "$GITHUB_OUTPUT"
          fi

      - name: Trigger docker builds
        if: steps.sync.outputs.new_tag != ''
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          echo "Dispatching build workflow for tag: ${{ steps.sync.outputs.new_tag }}"
          gh workflow run okernet-docker-build-push.yml --ref "${{ steps.sync.outputs.new_tag }}"