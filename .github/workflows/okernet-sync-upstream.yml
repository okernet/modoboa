name: okernet - Sync upstream (modoboa/modoboa)

on:
  schedule:
    # Every 6 hours
    - cron: "17 */6 * * *"
  workflow_dispatch:
  repository_dispatch:
    types: [upstream-sync]

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_PAT }}

      - name: Sync upstream branch + tags
        id: sync
        env:
          UPSTREAM_URL: https://github.com/modoboa/modoboa.git
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Determine default branch
          DEFAULT_BRANCH="$(git remote show origin | awk '/HEAD branch/ {print $NF}')"
          echo "Default branch: ${DEFAULT_BRANCH}"

          if ! git remote | grep -q '^upstream$'; then
            git remote add upstream "${UPSTREAM_URL}"
          fi

          # Snapshot existing tags before fetch
          BEFORE_TAGS="$(git tag -l | sort)"

          git fetch upstream --prune --tags

          # Detect new tags
          AFTER_TAGS="$(git tag -l | sort)"
          NEW_TAGS="$(comm -13 <(echo "$BEFORE_TAGS") <(echo "$AFTER_TAGS") || true)"

          if [ -n "$NEW_TAGS" ]; then
            echo "New tags from upstream:"
            echo "$NEW_TAGS"
            echo "new_tags<<EOF" >> "$GITHUB_OUTPUT"
            echo "$NEW_TAGS" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          else
            echo "No new tags."
            echo "new_tags=" >> "$GITHUB_OUTPUT"
          fi

          git checkout "${DEFAULT_BRANCH}"

          # Merge upstream default branch into ours
          git merge --no-edit "upstream/${DEFAULT_BRANCH}" || {
            echo "Merge failed (likely conflicts). Resolve manually in a PR or locally."
            exit 1
          }

          git push origin "${DEFAULT_BRANCH}"
          git push origin --tags

      - name: Trigger docker builds for new tags
        if: steps.sync.outputs.new_tags != ''
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          # Only trigger for semver tags (skip random branch-like names)
          echo "${{ steps.sync.outputs.new_tags }}" | grep -E '^v?[0-9]+\.[0-9]+' | while read -r tag; do
            echo "Dispatching build workflow for tag: ${tag}"
            gh workflow run okernet-docker-build-push.yml --ref "${tag}"
          done
